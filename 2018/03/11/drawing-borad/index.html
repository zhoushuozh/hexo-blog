<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="keywords" content="周硕的博客, 前端博客">
  <meta name="description" content="周硕的个人博客，此博客是我记录工作和学习的地方。">
  <title>使用JS和Canvas做一个画板 | 周硕的博客</title>
  
  
  <link rel="shortcut icon" href="/blog/assets/favicon.ico" >
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night.min.css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url(/blog/assets/header.png)">
        <div class='av-pic' style="background-image: url(/blog/assets/logo.jpg)">
        </div>
    </section>
    <section class='menu'>
        <div>周硕的博客</div>
        
        <ul>
          
            <a href="/blog/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/blog/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/blog/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/blog/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/zhoushuozh/">
                    <img src="/blog/assets/github.svg" />
                </a>
            
        
            
                <a href="https://weibo.com/zhoushuozh/">
                    <img src="/blog/assets/weibo.svg" />
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>使用JS和Canvas做一个画板</h1>
    </header>

    <section>
      <p><img src="https://blog.zhoushuo.me/zhoushuodrawing.png" alt="canvas画板截图"></p>
<p>前些天学习了<code>HTML5</code>的<code>&lt;canvas&gt;</code>元素，今天就来实践一下，用<code>canvas</code>做一个画板。</p>
<a id="more"></a>
<p>首先说一下要实现的功能：</p>
<ul>
<li>切换画笔颜色</li>
<li>调整笔刷粗细</li>
<li>清空画布</li>
<li>橡皮擦擦除</li>
<li>撤销操作</li>
<li>保存成图片</li>
<li>兼容移动端（支持触摸）</li>
</ul>
<p>好了，废话少说，先看最终效果：<a href="https://zhoushuozh.github.io/drawingborad" target="_blank" rel="noopener">https://zhoushuozh.github.io/drawingborad</a></p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>首先，准备个容器,也就是画板了。</p>
<pre><code class="HTML">&lt;canvas id=&quot;drawing-board&quot;&gt;&lt;/canvas&gt;
</code></pre>
<p>然后初始化js：</p>
<pre><code class="JavaScript">let canvas = document.getElementById(&quot;drawing-board&quot;);
let ctx = canvas.getContext(&quot;2d&quot;);
</code></pre>
<p>我想把画板做成全屏的，所以接下来设置一下<code>canvas</code>的宽高。</p>
<pre><code class="JavaScript">let pageWidth = document.documentElement.clientWidth;
let pageHeight = document.documentElement.clientHeight;

canvas.width = pageWidth;
canvas.height = pageHeight;
</code></pre>
<p>由于部分IE不支持<code>canvas</code>，如果要兼容IE，我们可以创建一个<code>canvas</code>，然后使用<code>excanvas</code>初始化，针对IE加上<a href="http://code.google.com/p/explorercanvas/" target="_blank" rel="noopener">exCanvas.js</a>，这里我们暂时先不考虑IE。</p>
<h3 id="实现一个简单的画板"><a href="#实现一个简单的画板" class="headerlink" title="实现一个简单的画板"></a>实现一个简单的画板</h3><p>实现思路：监听鼠标事件，用<code>drawCircle()</code>方法把记录的数据画出来。</p>
<ol>
<li>设置初始化当前画布功能为画笔状态，<code>painting = false</code>，</li>
<li>当鼠标按下时（<code>mousedown</code>），把<code>painting</code>设为<code>true</code>，表示正在画，鼠标没松开。把鼠标点记录下来。</li>
<li>当按下鼠标的时候，鼠标移动（<code>mousemove</code>）就把点记录下来并画出来。</li>
<li>如果鼠标移动过快，浏览器跟不上绘画速度，点与点之间会产品间隙，所以我们需要将画出的点用线连起来（<code>lineTo()</code>）。</li>
<li>鼠标松开的时候（<code>mouseup</code>），把<code>painting</code>设为<code>false</code>。</li>
</ol>
<p>代码：</p>
<pre><code class="JavaScript">let painting = false;
let lastPoint = {x: undefined, y: undefined};

//鼠标按下事件
canvas.onmousedown = function (e) {
    painting = true;
    let x = e.clientX;
    let y = e.clientY;
    lastPoint = {&quot;x&quot;: x, &quot;y&quot;: y};
    drawCircle(x, y, 5);
};

//鼠标移动事件
canvas.onmousemove = function (e) {
    if (painting) {
        let x = e.clientX;
        let y = e.clientY;
        let newPoint = {&quot;x&quot;: x, &quot;y&quot;: y};
        drawLine(lastPoint.x, lastPoint.y, newPoint.x, newPoint.y,clear);
        lastPoint = newPoint;
    }
};

//鼠标松开事件
canvas.onmouseup = function () {
    painting = false;
}

// 画点函数
function drawCircle(x, y, radius) {
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();
}

// 划线函数
function drawLine(x1, y1, x2, y2) {
    ctx.lineWidth = 3;
    ctx.lineCap = &quot;round&quot;;
    ctx.lineJoin = &quot;round&quot;;
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    ctx.closePath();
}
</code></pre>
<h3 id="橡皮擦功能"><a href="#橡皮擦功能" class="headerlink" title="橡皮擦功能"></a>橡皮擦功能</h3><p>实现思路</p>
<ol>
<li>获取橡皮擦元素</li>
<li>设置橡皮擦初始状态，<code>clear = false</code>。</li>
<li>监听橡皮擦<code>click</code>事件，点击橡皮擦，改变橡皮擦状态，<code>clear = true</code>。</li>
<li><code>clear</code>为<code>true</code>时，移动鼠标使用<code>canvas</code>剪裁（<code>clip()</code>）擦除画布。</li>
</ol>
<pre><code class="JavaScript">let eraser = document.getElementById(&quot;eraser&quot;);
let clear = false;

eraser.onclick = function () {
    clear = true;
};

...javaScript
if (clear) {
    ctx.save();
    ctx.globalCompositeOperation = &quot;destination-out&quot;;
    ctx.stroke();
    ctx.closePath();
    ctx.clip();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.restore();
}
...
</code></pre>
<p>注意，在<code>canvas</code>中的裁剪和平时的裁剪功能不一样在这里，裁剪是指在裁剪区域去显示我们所画的图</p>
<h3 id="兼容移动端"><a href="#兼容移动端" class="headerlink" title="兼容移动端"></a>兼容移动端</h3><p>实现思路：</p>
<ol>
<li>判断设备是否支持触摸</li>
<li><code>true</code>，则使用<code>touch</code>事件；<code>false</code>，则使用<code>mouse</code>事件</li>
</ol>
<p>代码：</p>
<pre><code class="JavaScript">...
if (document.body.ontouchstart !== undefined) {
    // 使用touch事件
    anvas.ontouchstart = function (e) {
        // 开始触摸
    }
    canvas.ontouchmove = function (e) {
        // 开始滑动
    }
    canvas.ontouchend = function () {
        // 滑动结束
    }
}else{
    // 使用mouse事件
    ...
}
...
</code></pre>
<p>这里需要注意的一点是，在<code>touch</code>事件里，是通过<code>.touches[0].clientX</code>和<code>.touches[0].clientY</code>来获取坐标的，这点要和<code>mouse</code>事件区别开。</p>
<h3 id="切换画笔颜色"><a href="#切换画笔颜色" class="headerlink" title="切换画笔颜色"></a>切换画笔颜色</h3><p>实现思路：</p>
<ol>
<li>获取颜色元素节点。</li>
<li>点击颜色返回其颜色值，并赋给画布的<code>ctx.strokeStyle</code>。</li>
</ol>
<p>代码：</p>
<pre><code class="JavaScript">let aColorBtn = document.getElementsByClassName(&quot;color-item&quot;);

for (let i = 0; i &lt; aColorBtn.length; i++) {
    aColorBtn[i].onclick = function () {
    for (let i = 0; i &lt; aColorBtn.length; i++) {
        activeColor = this.style.backgroundColor;
        ctx.strokeStyle = activeColor;
    }
}
</code></pre>
<h3 id="清空画布"><a href="#清空画布" class="headerlink" title="清空画布"></a>清空画布</h3><p>实现思路：</p>
<ol>
<li>获取元素节点。</li>
<li>点击清空按钮清空canvas画布。</li>
</ol>
<p>代码：</p>
<pre><code class="javascript">let reSetCanvas = document.getElementById(&quot;clear&quot;);

reSetCanvas.onclick = function () {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
};
</code></pre>
<h3 id="调整笔刷粗细"><a href="#调整笔刷粗细" class="headerlink" title="调整笔刷粗细"></a>调整笔刷粗细</h3><p>实现思路：</p>
<ol>
<li>创建input[type=range]</li>
<li>滑动range获取其value值，并赋给<code>ctx.lineWidth</code></li>
</ol>
<p>代码：</p>
<pre><code class="JavaScript">let range = document.getElementById(&quot;range&quot;);

range.onchange = function(){
    lWidth = this.value;
};
</code></pre>
<h3 id="保存成图片"><a href="#保存成图片" class="headerlink" title="保存成图片"></a>保存成图片</h3><p>实现思路：</p>
<ol>
<li>获取canvas.toDateURL</li>
<li>在页面里创建并插入一个a标签</li>
<li>a标签href等于canvas.toDateURL，并添加download属性</li>
<li>点击保存按钮，a标签触发click事件</li>
</ol>
<p>代码：</p>
<pre><code class="JavaScript">let save = document.getElementById(&quot;save&quot;);

save.onclick = function () {
    let imgUrl = canvas.toDataURL(&quot;image/png&quot;);
    let saveA = document.createElement(&quot;a&quot;);
    document.body.appendChild(saveA);
    saveA.href = imgUrl;
    saveA.download = &quot;zspic&quot; + (new Date).getTime();
    saveA.target = &quot;_blank&quot;;
    saveA.click();
};
</code></pre>
<h3 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h3><p>实现思路：</p>
<ol>
<li>准备一个数组记录历史操作</li>
<li>每次使用画笔前将当前绘图表面储存进数组</li>
<li>点击撤销时，恢复到上一步的绘图表面</li>
</ol>
<p>代码：</p>
<pre><code class="javascript">canvas.ontouchstart = function (e) {
     // 在这里储存绘图表面
    this.firstDot = ctx.getImageData(0, 0, canvas.width, canvas.height);
    saveData(this.firstDot);
    ...
}

let undo = document.getElementById(&quot;undo&quot;);
let historyDeta = [];

function saveData (data) {
    (historyDeta.length === 10) &amp;&amp; (historyDeta.shift()); // 上限为储存10步，太多了怕挂掉
    historyDeta.push(data);
}
undo.onclick = function(){
    if(historyDeta.length &lt; 1) return false;
    ctx.putImageData(historyDeta[historyDeta.length - 1], 0, 0);
    historyDeta.pop()
};
</code></pre>
<p>因为每次储存都是将一张图片存入内存，对性能影响较大，所以在这里设置了储存上限。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这里用的知识点主要有：监听<code>mouse</code>、<code>touch</code>事件，以及<code>canvas</code>的<code>moveTo()</code>、<code>lineTo()</code>、<code>stroke()</code>、<code>clip()</code>、<code>clearRect()</code>等方法。我相信还有很多效果可以实现，比如说类似喷雾效果，铅笔字效果，艺术画效果，等等。日后有时间我会继续对这个画板进行优化，增加一些新的功能同时欢迎大家留言提问或者提出批评建议。</p>
<p>最终代码：<a href="https://github.com/zhoushuozh/drawingborad" target="_blank" rel="noopener">https://github.com/zhoushuozh/drawingborad</a></p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2018-03-10T17:21:14.000Z" itemprop="datePublished">
              2018-03-11
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/blog/tags/JavaScript/">JavaScript</a> }
  </li>

  <li class="meta-text">
  { <a href="/blog/tags/HTML5/">HTML5</a> }
  </li>

  <li class="meta-text">
  { <a href="/blog/tags/canvas/">canvas</a> }
  </li>


            </div>
          
      </section>
    
     
</article>

  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<div id="gitalk-container"></div>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd50f82d1de5ab2dd34c6',
        clientSecret: '7ed79e0b3ad122582d5c8d7d5a295c1142743477',
        id: window.location.pathname,
        repo: 'comments',
        owner: 'zhoushuozh',
        admin: 'zhoushuozh'
    })
    gitalk.render('gitalk-container')
</script>

</div>

            <footer>
    <div>&copy; 2018 - 周硕 </div>
    <div>
    Powered by Hexo &nbsp; Theme by icalm
    </div>
</footer>
        </div>
    </div>
</div>
<script src="/blog/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<!--<script>hljs.initHighlightingOnLoad();</script>-->
</body>
</html>
